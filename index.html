<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ëª©í¬ ì•Œë¦¬ë¯¸ - ëŒ“ê¸€ (Firebase í†µí•©)</title>
<style>
  /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ê°„ë‹¨í•œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
  @font-face {
    font-family: 'ChangwonDangamRound';
    src: url('./fonts/ChangwonDangamRound.ttf') format('truetype');
    font-weight: normal; font-style: normal; font-display: swap;
  }
  body { font-family: 'ChangwonDangamRound','Noto Sans KR',sans-serif!important; background: linear-gradient(to bottom,#e0f7fa,#ffffff); color:#333; line-height:1.7; margin:0; }
  header{ background:rgba(255,255,255,0.95); padding:20px 24px; position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  .main-logo { font-size:20px; color:#00bcd4; font-weight:700; }
  .controls { display:flex; gap:10px; align-items:center; }
  .controls input[type="text"] { padding:6px 10px; border-radius:8px; border:1px solid #ccc; }
  .controls button { padding:6px 10px; border-radius:8px; border:none; background:#00bcd4; color:white; cursor:pointer; }
  main { max-width:1000px; margin:28px auto; padding:20px; }
  .hero { text-align:center; padding:40px; background: url('./images/mokpo-bridge.jpg') center/cover no-repeat; border-radius:12px; color:white; margin-bottom:20px; }
  section { background:white; padding:20px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
  .comment-form textarea { width:100%; padding:12px; border-radius:8px; border:2px solid #00bcd4; resize:vertical; min-height:80px; font-size:15px; }
  .comment-form .row { display:flex; gap:10px; margin-top:8px; }
  .comment-list { margin-top:16px; }
  .comment { background:#f8fdff; padding:14px; border-radius:10px; margin-bottom:12px; border-left:4px solid #00bcd4; position:relative; }
  .meta { font-size:12px; color:#666; display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px; }
  .actions button { background:none; border:none; cursor:pointer; margin-left:8px; font-size:14px; }
  .delete-btn { position:absolute; right:8px; top:8px; background:#ff4081; color:white; border:none; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:12px; }
  .admin-panel { margin-left:10px; }
  .small { font-size:13px; color:#555; }
</style>
</head>
<body>
<header>
  <div class="main-logo">ğŸ“¢ëª©í¬ ì•Œë¦¬ë¯¸</div>
  <div class="controls">
    <label class="small">ë‹‰ë„¤ì„: <input id="nicknameInput" type="text" placeholder="ë‹‰ë„¤ì„ ì„¤ì • (ì €ì¥ë¨)" /></label>
    <button id="saveNickBtn">ì €ì¥</button>
    <button id="openAdminBtn">ê´€ë¦¬ì</button>
  </div>
</header>

<main>
  <div class="hero">
    <h1>ë°”ë‹¤ ë‚´ìŒ ê°€ë“í•œ ë„ì‹œ, ëª©í¬</h1>
    <p>ì‹ ì„ í•œ í•´ì‚°ë¬¼ê³¼ ì•„ë¦„ë‹¤ìš´ í•­êµ¬, ë‚­ë§Œì´ ê°€ë“í•œ ì—¬í–‰ì§€</p>
  </div>

  <section>
    <h2>ğŸŒ‰ëª©í¬ ê·¼ëŒ€ì—­ì‚¬ê´€ í›„ê¸° & ëŒ“ê¸€</h2>

    <div class="comment-section">
      <div class="comment-form">
        <textarea id="commentInput" placeholder="ì—¬ê¸°ì— í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
        <div class="row">
          <button id="postCommentBtn">âŒ¨ï¸ëŒ“ê¸€ ë‹¬ê¸°</button>
          <span class="small">ë‹‰ë„¤ì„ì€ ì˜¤ë¥¸ìª½ ìƒë‹¨ì—ì„œ ì„¤ì •í•˜ì„¸ìš”. (ê¸°ë³¸: ìµëª…)</span>
        </div>
      </div>

      <div class="comment-list" id="commentList"></div>
    </div>
  </section>
</main>

<!-- ê´€ë¦¬ì ëª¨ë‹¬(ê°„ë‹¨) -->
<div id="adminModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
  <div style="background:white; padding:18px; border-radius:8px; width:360px;">
    <h3>ê´€ë¦¬ì íŒ¨ë„</h3>
    <div style="margin-bottom:8px;">
      <input id="adminPassInput" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥/ì„¤ì •" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;" />
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="adminSetBtn">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •(ì—†ì„ ì‹œ)</button>
      <button id="adminLoginBtn">ë¡œê·¸ì¸</button>
      <button id="adminCloseBtn">ë‹«ê¸°</button>
    </div>
    <div id="adminPanelInner" style="display:none; margin-top:12px;">
      <p class="small">ê´€ë¦¬ì ê¶Œí•œ: ëª¨ë“  ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</p>
      <button id="exportDataBtn">ëŒ“ê¸€ JSON ë‚´ë³´ë‚´ê¸°</button>
      <button id="clearAllBtn" style="background:#ff4081; color:white;">ëª¨ë‘ ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- Firebase compat scripts (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
/* -----------------------
  Firebase ì„¤ì • â€” ì—¬ê¸°ì— ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ ë„£ê¸°
  (Firebase ì½˜ì†”ì—ì„œ ì›¹ì•± ë“±ë¡ í›„ ë°œê¸‰ëœ config ë³µì‚¬)
------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyAYpl_9x-JKIY8HSrZE19Qmxn7rwxztRTQ",
  authDomain: "project-c9185.firebaseapp.com",
  databaseURL: "https://project-c9185-default-rtdb.firebaseio.com",
  projectId: "project-c9185",
  storageBucket: "project-c9185.firebasestorage.app",
  messagingSenderId: "612385081336",
  appId: "1:612385081336:web:d74353664ae69d1c95380d",
  measurementId: "G-TB70HV7Q8W"
};


/* ì´ˆê¸°í™” */
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -----------------------
  ìœ í‹¸: SHA-256 í•´ì‹œ (hex)
------------------------*/
async function sha256hex(str) {
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

/* -----------------------
  IP ì–»ê¸° (ê³µì¸ IP) â€” ipify ì‚¬ìš©
  ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
------------------------*/
async function getPublicIP() {
  try {
    const r = await fetch('https://api.ipify.org?format=json');
    if (!r.ok) throw new Error('ip fetch failed');
    const j = await r.json();
    return j.ip;
  } catch (e) {
    console.warn('IP fetch failed', e);
    return null;
  }
}

/* -----------------------
  ì‚¬ìš©ì ì‹ë³„ì ìƒì„±
  - localDeviceId: ê¸°ê¸° ë¡œì»¬ ì €ì¥(UUID)
  - ipHash: ê³µì¸IP í•´ì‹œ(ê°€ëŠ¥í•œ ê²½ìš°)
  - authorId = sha256(ipHash + localDeviceId) (ipHashê°€ nullì´ë©´ localDeviceId ê¸°ë°˜)
------------------------*/
function getOrCreateLocalId() {
  let id = localStorage.getItem('mokpo_localDeviceId');
  if (!id) {
    id = 'dev-' + Math.random().toString(36).slice(2,10);
    localStorage.setItem('mokpo_localDeviceId', id);
  }
  return id;
}

let userContext = {
  localId: getOrCreateLocalId(),
  ip: null,
  ipHash: null,
  authorId: null,
  nickname: localStorage.getItem('mokpo_nickname') || ''
};

/* ì´ˆê¸°í™” ë¹„ë™ê¸° ì‘ì—…: IP ê°€ì ¸ì˜¤ê³  í•´ì‹œ ê³„ì‚° */
(async () => {
  const ip = await getPublicIP();
  userContext.ip = ip;
  if (ip) {
    userContext.ipHash = await sha256hex(ip);
    userContext.authorId = await sha256hex(userContext.ipHash + userContext.localId);
  } else {
    userContext.ipHash = null;
    userContext.authorId = await sha256hex(userContext.localId);
  }
  // ë‹‰ë„¤ì„ UI ë°˜ì˜
  document.getElementById('nicknameInput').value = userContext.nickname;
})();

/* -----------------------
  ê°„ë‹¨í•œ ìš•ì„¤ í•„í„° (ë‹¨ì–´ë§Œ ìƒ˜í”Œ)
------------------------*/
const badWords = ['ì”¨ë°œ','ë³‘ì‹ ','ìì§€']; // ì‹¤ì œë¡œ ì°¨ë‹¨í•  ë‹¨ì–´ë¥¼ ì—¬ê¸°ì— ì¶”ê°€í•˜ì„¸ìš”
function sanitizeText(text) {
  let t = text;
  badWords.forEach(w => {
    if (!w) return;
    const regex = new RegExp(w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'ig');
    t = t.replace(regex, '***');
  });
  return t;
}

/* -----------------------
  DOM ë ˆí¼ëŸ°ìŠ¤ ë° ì´ë²¤íŠ¸
------------------------*/
const commentInput = document.getElementById('commentInput');
const postCommentBtn = document.getElementById('postCommentBtn');
const commentList = document.getElementById('commentList');
const nicknameInput = document.getElementById('nicknameInput');
const saveNickBtn = document.getElementById('saveNickBtn');

postCommentBtn.addEventListener('click', addComment);
saveNickBtn.addEventListener('click', () => {
  const v = nicknameInput.value.trim();
  if (v.length > 30) return alert('ë‹‰ë„¤ì„ì€ 30ì ì´í•˜ë¡œ í•´ì£¼ì„¸ìš”.');
  userContext.nickname = v || 'ìµëª…';
  localStorage.setItem('mokpo_nickname', userContext.nickname);
  alert('ë‹‰ë„¤ì„ ì €ì¥ë¨: ' + userContext.nickname);
});

/* -----------------------
  ëŒ“ê¸€ ì¶”ê°€
------------------------*/
async function addComment() {
  const raw = commentInput.value.trim();
  if (!raw) return alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
  // í•„í„°ë§
  const safe = sanitizeText(raw);
  const nickname = userContext.nickname || 'ìµëª…';

  // ì‘ì„±ì id (authorId) ë³´ì¡´
  const authorId = userContext.authorId || await sha256hex(getOrCreateLocalId());

  const newRef = db.ref('comments').push();
  await newRef.set({
    text: safe,
    nickname: nickname,
    date: new Date().toISOString(),
    likes: 0,
    dislikes: 0,
    voters: {}, // { ipHash: "like"|"dislike" }
    authorId: authorId
  });

  commentInput.value = '';
}

/* -----------------------
  ëŒ“ê¸€ ëª©ë¡ ì‹¤ì‹œê°„ ë¡œë“œ
------------------------*/
function createCommentElement(id, data, idx) {
  const div = document.createElement('div');
  div.className = 'comment';
  div.dataset.id = id;

  const textHtml = `<p><strong>${escapeHtml(data.nickname || 'ìµëª…')}</strong>: ${escapeHtml(data.text).replace(/\n/g,'<br>')}</p>`;
  const metaTime = new Date(data.date).toLocaleString('ko-KR');
  const likeCount = data.likes || 0;
  const dislikeCount = data.dislikes || 0;

  // ë²„íŠ¼ disabled ì—¬ë¶€ ê³„ì‚° (owner or admin allow edit)
  const isOwner = (data.authorId && userContext.authorId && data.authorId === userContext.authorId);
  const controls = `
    <div class="meta">
      <span>${metaTime}</span>
      <div class="actions">
        <button onclick="handleVote('${id}', 'like')">ğŸ‘<span class="like-count"> ${likeCount}</span></button>
        <button onclick="handleVote('${id}', 'dislike')">ğŸ‘<span class="dislike-count"> ${dislikeCount}</span></button>
        ${isOwner ? `<button onclick="editCommentPrompt('${id}')">ìˆ˜ì •</button>` : ''}
        <button onclick="tryDelete('${id}')">ì‚­ì œ</button>
      </div>
    </div>
  `;

  div.innerHTML = textHtml + controls;
  return div;
}

db.ref('comments').on('value', (snap) => {
  const obj = snap.val() || {};
  // ì•ˆì •ì ì¸ ìˆœì„œë¥¼ ìœ„í•´ ë‚ ì§œ ê¸°ì¤€ ì •ë ¬
  const entries = Object.entries(obj).sort((a,b) => {
    const da = new Date(a[1].date).getTime();
    const dbt = new Date(b[1].date).getTime();
    return dbt - da; // ìµœì‹ ìˆœ
  });

  commentList.innerHTML = '';
  entries.forEach(([id, data], idx) => {
    const el = createCommentElement(id, data, idx);
    commentList.appendChild(el);
  });
});

/* -----------------------
  íˆ¬í‘œ ì²˜ë¦¬ (IP ê¸°ë°˜ 1íšŒ)
------------------------*/
async function handleVote(id, type) {
  // get ipHash or fallback
  const ipHash = userContext.ipHash;
  const localKey = userContext.localId;
  const voterKey = ipHash ? await sha256hex(ipHash) : await sha256hex(localKey);

  const ref = db.ref('comments/' + id);
  ref.transaction(current => {
    if (!current) return current;
    current.voters = current.voters || {};
    const prev = current.voters[voterKey];

    // ê°™ì€ íˆ¬í‘œ ë°˜ë³µ ëˆ„ë¥´ë©´ ì·¨ì†Œ
    if (prev === type) {
      // cancel
      if (type === 'like') current.likes = Math.max(0, (current.likes||0) - 1);
      else current.dislikes = Math.max(0, (current.dislikes||0) - 1);
      delete current.voters[voterKey];
    } else {
      // ë‹¤ë¥¸ ìª½ìœ¼ë¡œ ë°”ê¾¸ê±°ë‚˜ ì²˜ìŒ íˆ¬í‘œ
      if (prev === 'like') current.likes = Math.max(0, (current.likes||0) - 1);
      if (prev === 'dislike') current.dislikes = Math.max(0, (current.dislikes||0) - 1);

      if (type === 'like') current.likes = (current.likes||0) + 1;
      else current.dislikes = (current.dislikes||0) + 1;

      current.voters[voterKey] = type;
    }
    return current;
  }, (err, committed, snapshot) => {
    if (err) console.error('vote transaction failed', err);
  });
}

/* -----------------------
  ëŒ“ê¸€ ì‚­ì œ ì‹œë„ (ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ)
------------------------*/
async function tryDelete(id) {
  const ref = db.ref('comments/' + id);
  const snap = await ref.once('value');
  const data = snap.val();
  if (!data) return alert('ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.');

  // ê´€ë¦¬ìë©´ ë°”ë¡œ ì‚­ì œ
  if (isAdmin) {
    if (confirm('ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) {
      ref.remove();
    }
    return;
  }

  // ì‘ì„±ì í™•ì¸
  if (data.authorId && userContext.authorId && data.authorId === userContext.authorId) {
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) ref.remove();
  } else {
    alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥)');
  }
}

/* -----------------------
  ëŒ“ê¸€ ìˆ˜ì • (í”„ë¡¬í”„íŠ¸ ê¸°ë°˜)
------------------------*/
async function editCommentPrompt(id) {
  const ref = db.ref('comments/' + id);
  const snap = await ref.once('value');
  const data = snap.val();
  if (!data) return alert('ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  // ê¶Œí•œ í™•ì¸
  if (!(isAdmin || (data.authorId && userContext.authorId && data.authorId === userContext.authorId))) {
    return alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
  }

  const newText = prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:', data.text);
  if (newText === null) return;
  const safe = sanitizeText(newText.trim());
  if (!safe) return alert('ë¹ˆ ëŒ“ê¸€ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

  await ref.update({ text: safe, editedAt: new Date().toISOString() });
}

/* -----------------------
  ë‹¨ìˆœí•œ HTML ì´ìŠ¤ì¼€ì´í”„
------------------------*/
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

/* -----------------------
  ê´€ë¦¬ì ê¸°ëŠ¥
  - ë¹„ë°€ë²ˆí˜¸ë¥¼ DBì— ì €ì¥ëœ í•´ì‹œì™€ ë¹„êµ
  - ê²½ë¡œ: /admin/passHash
  - ìµœì´ˆ ì„¤ì • ì‹œ ë¹ˆ ê°’ì´ë©´ setìœ¼ë¡œ ì €ì¥
------------------------*/
let isAdmin = false;

const adminModal = document.getElementById('adminModal');
document.getElementById('openAdminBtn').addEventListener('click', () => adminModal.style.display = 'flex');
document.getElementById('adminCloseBtn').addEventListener('click', () => adminModal.style.display = 'none');

document.getElementById('adminSetBtn').addEventListener('click', async () => {
  const pass = document.getElementById('adminPassInput').value;
  if (!pass) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const passRef = db.ref('admin/passHash');
  const snap = await passRef.once('value');
  if (snap.exists()) return alert('ì´ë¯¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
  const h = await sha256hex(pass);
  await passRef.set(h);
  alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
});

document.getElementById('adminLoginBtn').addEventListener('click', async () => {
  const pass = document.getElementById('adminPassInput').value;
  if (!pass) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const passRef = db.ref('admin/passHash');
  const snap = await passRef.once('value');
  if (!snap.exists()) return alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.');
  const storedHash = snap.val();
  const h = await sha256hex(pass);
  if (h === storedHash) {
    isAdmin = true;
    alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ');
    document.getElementById('adminPanelInner').style.display = 'block';
  } else {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  }
});

/* ê´€ë¦¬ì: ëŒ“ê¸€ JSON ë‚´ë³´ë‚´ê¸° */
document.getElementById('exportDataBtn').addEventListener('click', async () => {
  if (!isAdmin) return alert('ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”');
  const snap = await db.ref('comments').once('value');
  const data = snap.val() || {};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'comments.json';
  a.click();
  URL.revokeObjectURL(url);
});

/* ê´€ë¦¬ì: ì „ì²´ ì‚­ì œ */
document.getElementById('clearAllBtn').addEventListener('click', async () => {
  if (!isAdmin) return alert('ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”');
  if (!confirm('ì •ë§ ëª¨ë“  ëŒ“ê¸€ì„ ì‚­ì œí•©ë‹ˆê¹Œ?')) return;
  await db.ref('comments').remove();
  alert('ëª¨ë‘ ì‚­ì œë¨');
});

/* -----------------------
  ì´ˆê¹ƒê°’: ë‹‰ë„¤ì„ê³¼ ë²„íŠ¼ ì´ë²¤íŠ¸
------------------------*/
document.addEventListener('DOMContentLoaded', () => {
  // ë‹‰ë„¤ì„ ì´ˆê¸°ê°’
  document.getElementById('nicknameInput').value = userContext.nickname || '';
});

/* -----------------------
  window ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ (onclickì—ì„œ í˜¸ì¶œë˜ë„ë¡)
------------------------*/
window.handleVote = handleVote;
window.tryDelete = tryDelete;
window.editCommentPrompt = editCommentPrompt;

</script>
</body>
</html>
