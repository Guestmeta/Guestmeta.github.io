<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ëª©í¬ ì•Œë¦¬ë¯¸</title>
<style>
  @font-face {
    font-family: 'ChangwonDangamRound';
    src: url('./fonts/ChangwonDangamRound.ttf') format('truetype');
    font-weight: normal; font-style: normal; font-display: swap;
  }
  body { font-family: 'ChangwonDangamRound','Noto Sans KR',sans-serif!important; background: linear-gradient(to bottom,#e0f7fa,#ffffff); color:#333; line-height:1.7; margin:0; }
  header{ background:rgba(255,255,255,0.95); padding:20px 24px; position:sticky; top:0; z-index:10; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  .main-logo { font-size:20px; color:#00bcd4; font-weight:700; margin-right:auto; }
  .tabs { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; }
  .tab-btn { padding:12px 24px; background:#e0f7fa; color:#333; border:none; border-radius:30px; font-size:18px; cursor:pointer; transition:all 0.3s; }
  .tab-btn.active { background:#00bcd4; color:white; }
  .controls { display:flex; gap:10px; align-items:center; margin-left:auto; }
  .controls input[type="text"] { padding:6px 10px; border-radius:8px; border:1px solid #ccc; }
  .controls button { padding:6px 10px; border-radius:8px; border:none; background:#00bcd4; color:white; cursor:pointer; }
  main { max-width:1000px; margin:28px auto; padding:20px; }
  .hero { text-align:center; padding:40px; background: url('./images/mokpo-bridge.jpg') center/cover no-repeat; border-radius:12px; color:white; margin-bottom:40px; }
  .aibox { padding:40px; border-radius: 12px; margin-bottom: 30px; background-color: white; box-shadow:0 6px 20px rgba(0,0,0,0.08); align-items: center; text-align: center;}
  .tab-content { display:none; }
  .tab-content.active { display:block; animation:slideDown 0.6s ease-out; }
  @keyframes slideDown { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }
  .places-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px,1fr)); gap:20px; }
  .place-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.08); transition:transform 0.3s; }
  .place-card:hover { transform:translateY(-8px); }
  .place-card img { width:100%; height:200px; object-fit:cover; }
  .place-info { padding:16px; }
  .place-info h3 { margin:0 0 8px; color:#00bcd4; }
  .place-info p { margin:0; font-size:14px; color:#555; }
  .comment-form textarea { width:100%; padding:12px; border-radius:8px; border:2px solid #00bcd4; resize:vertical; min-height:80px; font-size:15px; }
  .comment-form .row { display:flex; gap:10px; margin-top:8px; align-items:center; }
  .comment-list { margin-top:16px; }
  .comment { background:#f8fdff; padding:14px; border-radius:10px; margin-bottom:12px; border-left:4px solid #00bcd4; position:relative; }
  .meta { font-size:12px; color:#666; display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px; }
  .actions button { background:none; border:none; cursor:pointer; margin-left:8px; font-size:14px; }
  .small { font-size:13px; color:#555; }
</style>
</head>
<body>
<header>
  <div class="main-logo">ğŸ“¢ëª©í¬ ì•Œë¦¬ë¯¸</div>
  <div class="tabs">
    <button class="tab-btn active" data-tab="ai_tap">AI</button>
    <button class="tab-btn" data-tab="attractions">ëª…ì†Œ</button>
    <button class="tab-btn" data-tab="restaurants">ë§›ì§‘</button>
    <button class="tab-btn" data-tab="accommodations">ìˆ™ì†Œ</button>
  </div>
  <div class="controls">
    <label class="small">ë‹‰ë„¤ì„: <input id="nicknameInput" type="text" placeholder="ë‹‰ë„¤ì„ ì„¤ì • (ì €ì¥ë¨)" /></label>
    <button id="saveNickBtn">ì €ì¥</button>
    <button id="openAdminBtn">ê´€ë¦¬ì</button>
  </div>
</header>

<main>
  <div class="hero">
    <h1>ë°”ë‹¤ ë‚´ìŒ ê°€ë“í•œ ë„ì‹œ, ëª©í¬</h1>
    <p>ì‹ ì„ í•œ í•´ì‚°ë¬¼ê³¼ ì•„ë¦„ë‹¤ìš´ í•­êµ¬, ë‚­ë§Œì´ ê°€ë“í•œ ì—¬í–‰ì§€</p>
  </div>

  <div id="ai_tap" class="tab-content active">
  <div class="aibox">
    <p style="font-size: 20px; font-weight: bold;">AIì—ê²Œ ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”!</p>
    <img src="images/AI_thinking.webp" alt="AI" style="border-radius: 10px; width: 50%; height: auto; margin: 20px 0;">
    <p>ëª©í¬ ì—¬í–‰, ëª…ì†Œ, ë§›ì§‘, ìˆ™ì†Œ ë“± ë­ë“  ë¬¼ì–´ë³´ì„¸ìš”!</p>
    <p style="font-weight: bold;">ì˜ˆì‹œ) 2ë°• 3ì¼ ëª©í¬ ì—¬í–‰ ì½”ìŠ¤ ì¶”ì²œ, ìœ ë‹¬ì‚° ê°€ëŠ” ë²•, ìµœê³ ì˜ ë¯¼ì–´ ë§›ì§‘ì€?</p>

    <div style="margin-top: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
      <div id="aiChatLog" style="height: 400px; overflow-y: auto; background: #f8fdff; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e0f2f1; font-size: 15px;">
        <p style="text-align:center; color:#888; font-style:italic;">AIì™€ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ì•„ë˜ì— ì§ˆë¬¸ ì…ë ¥ â†’ ì—”í„°</p>
      </div>

      <div style="display: flex; gap: 10px;">
        <input type="text" id="aiInput" placeholder="ì—¬ê¸°ì— ì§ˆë¬¸ ì…ë ¥..." style="flex:1; padding:14px; border-radius:12px; border:2px solid #00bcd4; font-size:16px;" autocomplete="off" />
        <button id="aiSendBtn" style="padding:14px 24px; border-radius:12px; border:none; background:#00bcd4; color:white; font-weight:600; cursor:pointer; font-size:16px;">ì „ì†¡</button>
      </div>
      <p style="font-size:13px; color:#888; margin-top:10px; text-align:center;">ë¡œì»¬ AI (Ollama)ë¡œ ë™ì‘ ì¤‘ â€¢ ê°œì¸ì •ë³´ ìœ ì¶œ ì—†ìŒ</p>
    </div>
  </div>
</div>
  <div id="attractions" class="tab-content">
    <h2 style="text-align:center; margin-bottom:30px;">ğŸŒ‰ ëª©í¬ ëª…ì†Œ</h2>
    <div class="places-grid">
      <div class="place-card">
        <img src="images/Mokpo_San.webp" alt="ìœ ë‹¬ì‚°">
        <div class="place-info">
          <h3>ìœ ë‹¬ì‚°</h3>
          <p>ëª©í¬ì˜ ìƒì§•ì ì¸ ì‚°ìœ¼ë¡œ ì¼ì¶œê³¼ ì•¼ê²½ì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤. ì •ìƒì—ì„œ ë‹¤ë„í•´ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
        </div>
      </div>
      <div class="place-card">
        <img src="images/MOC.jpg" alt="ëª©í¬ í•´ìƒì¼€ì´ë¸”ì¹´">
        <div class="place-info">
          <h3>ëª©í¬ í•´ìƒì¼€ì´ë¸”ì¹´</h3>
          <p>ì•„ì‹œì•„ ìµœì¥ í•´ìƒ ì¼€ì´ë¸”ì¹´ë¡œ ìœ ë‹¬ì‚°ê³¼ ê³ í•˜ë„ë¥¼ ì—°ê²°í•˜ë©° ë°”ë‹¤ ìœ„ë¥¼ ë‚ ì•„ê°€ëŠ” ë“¯í•œ ê²½í—˜ì„ ì„ ì‚¬í•©ë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="place-card">
        <img src="images/history_build.jpg" alt="ëª©í¬ ê·¼ëŒ€ì—­ì‚¬ê´€">
        <div class="place-info">
          <h3>ëª©í¬ ê·¼ëŒ€ì—­ì‚¬ê´€</h3>
          <p>ì¼ì œê°•ì ê¸° ê±´ì¶•ë¬¼ë¡œ ëª©í¬ì˜ ê·¼ëŒ€ ì—­ì‚¬ë¥¼ ìƒìƒíˆ ëŠë‚„ ìˆ˜ ìˆëŠ” ê³³ì…ë‹ˆë‹¤.</p>
        </div>
      </div>   
    </div>
    <!-- <P style="margin: 10px;"></P>
    <div class="places-grid">
      <div class="place-card">
        <img src="images/Mokpo_San.webp" alt="ìœ ë‹¬ì‚°">
        <div class="place-info">
          <h3>ìœ ë‹¬ì‚°</h3>
          <p>ëª©í¬ì˜ ìƒì§•ì ì¸ ì‚°ìœ¼ë¡œ ì¼ì¶œê³¼ ì•¼ê²½ì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤. ì •ìƒì—ì„œ ë‹¤ë„í•´ë¥¼ í•œëˆˆì— ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
        </div>
      </div>
      <div class="place-card">
        <img src="images/MOC.jpg" alt="ëª©í¬ í•´ìƒì¼€ì´ë¸”ì¹´">
        <div class="place-info">
          <h3>ëª©í¬ í•´ìƒì¼€ì´ë¸”ì¹´</h3>
          <p>ì•„ì‹œì•„ ìµœì¥ í•´ìƒ ì¼€ì´ë¸”ì¹´ë¡œ ìœ ë‹¬ì‚°ê³¼ ê³ í•˜ë„ë¥¼ ì—°ê²°í•˜ë©° ë°”ë‹¤ ìœ„ë¥¼ ë‚ ì•„ê°€ëŠ” ë“¯í•œ ê²½í—˜ì„ ì„ ì‚¬í•©ë‹ˆë‹¤.</p>
        </div>
      </div>
      <div class="place-card">
        <img src="images/history_build.jpg" alt="ëª©í¬ ê·¼ëŒ€ì—­ì‚¬ê´€">
        <div class="place-info">
          <h3>ëª©í¬ ê·¼ëŒ€ì—­ì‚¬ê´€</h3>
          <p>ì¼ì œê°•ì ê¸° ê±´ì¶•ë¬¼ë¡œ ëª©í¬ì˜ ê·¼ëŒ€ ì—­ì‚¬ë¥¼ ìƒìƒíˆ ëŠë‚„ ìˆ˜ ìˆëŠ” ê³³ì…ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div> -->
  </div>

  <div id="restaurants" class="tab-content">
    <h2 style="text-align:center; margin-bottom:30px;">ğŸ´ ëª©í¬ ë§›ì§‘</h2>
    <div class="places-grid">
      <div class="place-card">
        <img src="" alt="ë§›ì§‘ 1">
        <div class="place-info">
          <h3>ë§›ì§‘ 1</h3>
          <p>ë§›ì§‘ ì„¤ëª… 1</p>
        </div>
      </div>
      <div class="place-card">
        <img src="" alt="ë§›ì§‘ 2">
        <div class="place-info">
          <h3>ë§›ì§‘ 2</h3>
          <p>ë§›ì§‘ ì„¤ëª… 2</p>
        </div>
      </div>
      <div class="place-card">
        <img src="" alt="ë§›ì§‘ 3">
        <div class="place-info">
          <h3>ë§›ì§‘ 3</h3>
          <p>ë§›ì§‘ ì„¤ëª… 3</p>
        </div>
      </div>
    </div>
  </div>

  <div id="accommodations" class="tab-content">
    <h2 style="text-align:center; margin-bottom:30px;">ğŸ¨ ëª©í¬ ìˆ™ì†Œ</h2>
    <div class="places-grid">
      <div class="place-card">
        <img src="" alt="ìˆ™ì†Œ 1">
        <div class="place-info">
          <h3>ìˆ™ì†Œ 1</h3>
          <p>ìˆ™ì†Œ ì„¤ëª… 1</p>
        </div>
      </div>
      <div class="place-card">
        <img src="" alt="ìˆ™ì†Œ 2">
        <div class="place-info">
          <h3>ìˆ™ì†Œ 2</h3>
          <p>ìˆ™ì†Œ ì„¤ëª… 2</p>
        </div>
      </div>
      <div class="place-card">
        <img src="" alt="ìˆ™ì†Œ 3">
        <div class="place-info">
          <h3>ìˆ™ì†Œ 3</h3>
          <p>ìˆ™ì†Œ ì„¤ëª… 3</p>
        </div>
      </div>
    </div>
  </div>

  <section style="margin-top:60px;">
    <h2 style="text-align:center;">ğŸ’¬ ë°©ë¬¸ í›„ê¸° & ëŒ“ê¸€</h2>
    <div class="comment-form">
      <textarea id="commentInput" placeholder="ëª©í¬ ì—¬í–‰ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
      <div class="row">
        <button id="postCommentBtn">âŒ¨ï¸ëŒ“ê¸€ ë‹¬ê¸°</button>
        <span class="small">ë‹‰ë„¤ì„ì€ ì˜¤ë¥¸ìª½ ìƒë‹¨ì—ì„œ ì„¤ì •í•˜ì„¸ìš”. (ê¸°ë³¸: ìµëª…)</span>
      </div>
    </div>
    <div class="comment-list" id="commentList"></div>
  </section>
</main>

<div id="adminModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center;">
  <div style="background:white; padding:18px; border-radius:8px; width:360px;">
    <h3>ê´€ë¦¬ì íŒ¨ë„</h3>
    <div style="margin-bottom:8px;">
      <input id="adminPassInput" type="password" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥/ì„¤ì •" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;" />
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button id="adminSetBtn">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •(ì—†ì„ ì‹œ)</button>
      <button id="adminLoginBtn">ë¡œê·¸ì¸</button>
      <button id="adminCloseBtn">ë‹«ê¸°</button>
    </div>
    <div id="adminPanelInner" style="display:none; margin-top:12px;">
      <p class="small">ê´€ë¦¬ì ê¶Œí•œ: ëª¨ë“  ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</p>
      <button id="exportDataBtn">ëŒ“ê¸€ JSON ë‚´ë³´ë‚´ê¸°</button>
      <button id="clearAllBtn" style="background:#ff4081; color:white;">ëª¨ë‘ ì‚­ì œ</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYpl_9x-JKIY8HSrZE19Qmxn7rwxztRTQ",
  authDomain: "project-c9185.firebaseapp.com",
  databaseURL: "https://project-c9185-default-rtdb.firebaseio.com",
  projectId: "project-c9185",
  storageBucket: "project-c9185.firebasestorage.app",
  messagingSenderId: "612385081336",
  appId: "1:612385081336:web:d74353664ae69d1c95380d",
  measurementId: "G-TB70HV7Q8W"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

async function sha256hex(str) {
  const enc = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(hash));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

async function getPublicIP() {
  try {
    const r = await fetch('https://api.ipify.org?format=json');
    if (!r.ok) throw new Error('ip fetch failed');
    const j = await r.json();
    return j.ip;
  } catch (e) {
    console.warn('IP fetch failed', e);
    return null;
  }
}

function getOrCreateLocalId() {
  let id = localStorage.getItem('mokpo_localDeviceId');
  if (!id) {
    id = 'dev-' + Math.random().toString(36).slice(2,10);
    localStorage.setItem('mokpo_localDeviceId', id);
  }
  return id;
}

let userContext = {
  localId: getOrCreateLocalId(),
  ip: null,
  ipHash: null,
  authorId: null,
  nickname: localStorage.getItem('mokpo_nickname') || ''
};

(async () => {
  const ip = await getPublicIP();
  userContext.ip = ip;
  if (ip) {
    userContext.ipHash = await sha256hex(ip);
    userContext.authorId = await sha256hex(userContext.ipHash + userContext.localId);
  } else {
    userContext.ipHash = null;
    userContext.authorId = await sha256hex(userContext.localId);
  }
  document.getElementById('nicknameInput').value = userContext.nickname;
})();

const badWords = ['ì”¨ë°œ','ë³‘ì‹ ','ë²„ëŸ¬ì§€']; 
function sanitizeText(text) {
  let t = text;
  badWords.forEach(w => {
    if (!w) return;
    const regex = new RegExp(w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'ig');
    t = t.replace(regex, '***');
  });
  return t;
}

const commentInput = document.getElementById('commentInput');
const postCommentBtn = document.getElementById('postCommentBtn');
const commentList = document.getElementById('commentList');
const nicknameInput = document.getElementById('nicknameInput');
const saveNickBtn = document.getElementById('saveNickBtn');

postCommentBtn.addEventListener('click', addComment);
saveNickBtn.addEventListener('click', () => {
  const v = nicknameInput.value.trim();
  if (v.length > 30) return alert('ë‹‰ë„¤ì„ì€ 30ì ì´í•˜ë¡œ í•´ì£¼ì„¸ìš”.');
  userContext.nickname = v || 'ìµëª…';
  localStorage.setItem('mokpo_nickname', userContext.nickname);
  alert('ë‹‰ë„¤ì„ ì €ì¥ë¨: ' + userContext.nickname);
});

async function addComment() {
  const raw = commentInput.value.trim();
  if (!raw) return alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const safe = sanitizeText(raw);
  const nickname = userContext.nickname || 'ìµëª…';

  const authorId = userContext.authorId || await sha256hex(getOrCreateLocalId());

  const newRef = db.ref('comments').push();
  await newRef.set({
    text: safe,
    nickname: nickname,
    date: new Date().toISOString(),
    likes: 0,
    dislikes: 0,
    voters: {},
    authorId: authorId
  });

  commentInput.value = '';
}

function createCommentElement(id, data) {
  const div = document.createElement('div');
  div.className = 'comment';
  div.dataset.id = id;

  const textHtml = `<p><strong>${escapeHtml(data.nickname || 'ìµëª…')}</strong>: ${escapeHtml(data.text).replace(/\n/g,'<br>')}</p>`;
  const metaTime = new Date(data.date).toLocaleString('ko-KR');
  const likeCount = data.likes || 0;
  const dislikeCount = data.dislikes || 0;

  const isOwner = (data.authorId && userContext.authorId && data.authorId === userContext.authorId);
  const controls = `
    <div class="meta">
      <span>${metaTime}</span>
      <div class="actions">
        <button onclick="handleVote('${id}', 'like')">ğŸ‘ ${likeCount}</button>
        <button onclick="handleVote('${id}', 'dislike')">ğŸ‘ ${dislikeCount}</button>
        ${isOwner ? `<button onclick="editCommentPrompt('${id}')">ìˆ˜ì •</button>` : ''}
        <button onclick="tryDelete('${id}')">ì‚­ì œ</button>
      </div>
    </div>
  `;

  div.innerHTML = textHtml + controls;
  return div;
}

db.ref('comments').on('value', (snap) => {
  const obj = snap.val() || {};
  const entries = Object.entries(obj).sort((a,b) => new Date(b[1].date).getTime() - new Date(a[1].date).getTime());

  commentList.innerHTML = '';
  entries.forEach(([id, data]) => {
    const el = createCommentElement(id, data);
    commentList.appendChild(el);
  });
});

async function handleVote(id, type) {
  const ipHash = userContext.ipHash;
  const localKey = userContext.localId;
  const voterKey = ipHash ? await sha256hex(ipHash) : await sha256hex(localKey);

  const ref = db.ref('comments/' + id);
  ref.transaction(current => {
    if (!current) return current;
    current.voters = current.voters || {};
    const prev = current.voters[voterKey];

    if (prev === type) {
      if (type === 'like') current.likes = Math.max(0, (current.likes||0) - 1);
      else current.dislikes = Math.max(0, (current.dislikes||0) - 1);
      delete current.voters[voterKey];
    } else {
      if (prev === 'like') current.likes = Math.max(0, (current.likes||0) - 1);
      if (prev === 'dislike') current.dislikes = Math.max(0, (current.dislikes||0) - 1);

      if (type === 'like') current.likes = (current.likes||0) + 1;
      else current.dislikes = (current.dislikes||0) + 1;

      current.voters[voterKey] = type;
    }
    return current;
  });
}

async function tryDelete(id) {
  const ref = db.ref('comments/' + id);
  const snap = await ref.once('value');
  const data = snap.val();
  if (!data) return alert('ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.');

  if (isAdmin) {
    if (confirm('ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?')) {
      ref.remove();
    }
    return;
  }

  if (data.authorId && userContext.authorId && data.authorId === userContext.authorId) {
    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) ref.remove();
  } else {
    alert('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥)');
  }
}

async function editCommentPrompt(id) {
  const ref = db.ref('comments/' + id);
  const snap = await ref.once('value');
  const data = snap.val();
  if (!data) return alert('ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  if (!(isAdmin || (data.authorId && userContext.authorId && data.authorId === userContext.authorId))) {
    return alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
  }

  const newText = prompt('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì„¸ìš”:', data.text);
  if (newText === null) return;
  const safe = sanitizeText(newText.trim());
  if (!safe) return alert('ë¹ˆ ëŒ“ê¸€ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');

  await ref.update({ text: safe, editedAt: new Date().toISOString() });
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

let isAdmin = false;

const adminModal = document.getElementById('adminModal');
document.getElementById('openAdminBtn').addEventListener('click', () => adminModal.style.display = 'flex');
document.getElementById('adminCloseBtn').addEventListener('click', () => adminModal.style.display = 'none');

document.getElementById('adminSetBtn').addEventListener('click', async () => {
  const pass = document.getElementById('adminPassInput').value;
  if (!pass) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const passRef = db.ref('admin/passHash');
  const snap = await passRef.once('value');
  if (snap.exists()) return alert('ì´ë¯¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
  const h = await sha256hex(pass);
  await passRef.set(h);
  alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.');
});

document.getElementById('adminLoginBtn').addEventListener('click', async () => {
  const pass = document.getElementById('adminPassInput').value;
  if (!pass) return alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const passRef = db.ref('admin/passHash');
  const snap = await passRef.once('value');
  if (!snap.exists()) return alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”.');
  const storedHash = snap.val();
  const h = await sha256hex(pass);
  if (h === storedHash) {
    isAdmin = true;
    alert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ');
    document.getElementById('adminPanelInner').style.display = 'block';
  } else {
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
  }
});

document.getElementById('exportDataBtn').addEventListener('click', async () => {
  if (!isAdmin) return alert('ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”');
  const snap = await db.ref('comments').once('value');
  const data = snap.val() || {};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'comments.json';
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('clearAllBtn').addEventListener('click', async () => {
  if (!isAdmin) return alert('ê´€ë¦¬ì ë¡œê·¸ì¸ í•„ìš”');
  if (!confirm('ì •ë§ ëª¨ë“  ëŒ“ê¸€ì„ ì‚­ì œí•©ë‹ˆê¹Œ?')) return;
  await db.ref('comments').remove();
  alert('ëª¨ë‘ ì‚­ì œë¨');
});

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('nicknameInput').value = userContext.nickname || '';

  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      tabContents.forEach(c => c.classList.remove('active'));
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });
});

window.handleVote = handleVote;
window.tryDelete = tryDelete;
window.editCommentPrompt = editCommentPrompt;

// === Ollama AI ì±„íŒ… ê¸°ëŠ¥ ===
const aiInput = document.getElementById('aiInput');
const aiSendBtn = document.getElementById('aiSendBtn');
const aiChatLog = document.getElementById('aiChatLog');

async function callOllama(prompt) {
  const loadingMsg = document.createElement('div');
  loadingMsg.textContent = 'AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...';
  loadingMsg.style.color = '#666';
  loadingMsg.style.fontStyle = 'italic';
  loadingMsg.style.margin = '10px 0';
  aiChatLog.appendChild(loadingMsg);
  aiChatLog.scrollTop = aiChatLog.scrollHeight;

  try {
    const response = await fetch('http://localhost:11434/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'llama3.2',  // í•„ìš”ì‹œ ë‹¤ë¥¸ ëª¨ë¸ë¡œ ë³€ê²½ (ollama listë¡œ í™•ì¸)
        prompt: prompt,
        stream: false
      })
    });

    if (!response.ok) {
      throw new Error('Ollama ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    const data = await response.json();
    return data.response || 'ë‹µë³€ì´ ì—†ì–´ìš”.';
  } catch (error) {
    return 'ì˜¤ë¥˜: ' + error.message + '\ní„°ë¯¸ë„ì—ì„œ Ollamaê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!';
  } finally {
    if (loadingMsg.parentNode) {
      loadingMsg.parentNode.removeChild(loadingMsg);
    }
  }
}

async function sendAIQuestion() {
  const question = aiInput.value.trim();
  if (!question) return;

  // ì‚¬ìš©ì ì§ˆë¬¸ í‘œì‹œ
  const userMsg = document.createElement('div');
  userMsg.style.marginBottom = '15px';
  userMsg.style.textAlign = 'right';
  userMsg.innerHTML = `<strong style="color:#00bcd4;">ë‚˜:</strong> ${escapeHtml(question)}`;
  aiChatLog.appendChild(userMsg);

  aiInput.value = '';
  aiChatLog.scrollTop = aiChatLog.scrollHeight;

  // AI ë‹µë³€ ë°›ê¸°
  const aiResponse = await callOllama(question);

  // AI ë‹µë³€ í‘œì‹œ
  const aiMsg = document.createElement('div');
  aiMsg.style.marginBottom = '20px';
  aiMsg.style.padding = '14px';
  aiMsg.style.background = '#e0f7fa';
  aiMsg.style.borderRadius = '12px';
  aiMsg.style.borderLeft = '4px solid #00bcd4';
  aiMsg.innerHTML = `<strong style="color:#006064;">AI:</strong> ${aiResponse.replace(/\n/g, '<br>')}`;
  aiChatLog.appendChild(aiMsg);

  aiChatLog.scrollTop = aiChatLog.scrollHeight;
}

// ì—”í„°í‚¤ë‚˜ ë²„íŠ¼ìœ¼ë¡œ ì „ì†¡
aiSendBtn.addEventListener('click', sendAIQuestion);
aiInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendAIQuestion();
  }
});

</script>
</body>
</html>